<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APIæµ‹è¯• - Ryan Mall</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .results-container {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #fff;
        }
        .test-summary {
            background: #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container my-5">
        <h1>APIè¿æ¥æµ‹è¯•</h1>
        <p>è¿™ä¸ªé¡µé¢ç”¨äºæµ‹è¯•å‰ç«¯æ˜¯å¦èƒ½æ­£ç¡®è¿æ¥åˆ°åç«¯API</p>
        
        <div class="row">
            <div class="col-md-6">
                <h3>æµ‹è¯•é¡¹ç›®</h3>
                <div class="mb-3">
                    <button class="btn btn-primary mb-2 w-100" onclick="testPing()">1. æµ‹è¯•åŸºç¡€è¿æ¥ (/ping)</button>
                    <button class="btn btn-primary mb-2 w-100" onclick="testProducts()">2. æµ‹è¯•å•†å“API (/api/v1/products)</button>
                    <button class="btn btn-primary mb-2 w-100" onclick="testCategories()">3. æµ‹è¯•åˆ†ç±»API (/api/v1/categories)</button>
                    <button class="btn btn-primary mb-2 w-100" onclick="testLogin()">4. æµ‹è¯•ç™»å½•API (/api/v1/login)</button>
                    <button class="btn btn-success mb-2 w-100" onclick="testCart()">5. æµ‹è¯•è´­ç‰©è½¦API (/api/v1/cart)</button>
                </div>
                <div class="mb-3">
                    <button class="btn btn-info mb-2 w-100" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
                    <button class="btn btn-warning mb-2 w-100" onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
                </div>
                <div id="testSummary" class="test-summary" style="display: none;">
                    <div id="summaryContent"></div>
                </div>
            </div>

            <div class="col-md-6">
                <h3>æµ‹è¯•ç»“æœ <small class="text-muted">(æœ€æ–°ç»“æœåœ¨é¡¶éƒ¨)</small></h3>
                <div class="results-container">
                    <div id="results"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:8081';

        // æµ‹è¯•ç»Ÿè®¡
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0
        };

        function addResult(title, content, isSuccess = true) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            div.innerHTML = `<strong>${title}</strong>\n${content}`;

            // å°†æ–°ç»“æœæ’å…¥åˆ°é¡¶éƒ¨
            results.insertBefore(div, results.firstChild);

            // æ›´æ–°ç»Ÿè®¡
            testStats.total++;
            if (isSuccess) {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            updateSummary();
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testStats = { total: 0, passed: 0, failed: 0 };
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('testSummary');
            const content = document.getElementById('summaryContent');

            if (testStats.total > 0) {
                const successRate = ((testStats.passed / testStats.total) * 100).toFixed(1);
                content.innerHTML = `
                    ğŸ“Š æµ‹è¯•ç»Ÿè®¡: æ€»è®¡ ${testStats.total} | âœ… æˆåŠŸ ${testStats.passed} | âŒ å¤±è´¥ ${testStats.failed} | æˆåŠŸç‡ ${successRate}%
                `;
                summary.style.display = 'block';
            } else {
                summary.style.display = 'none';
            }
        }
        
        async function testPing() {
            try {
                addResult('å¼€å§‹æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•åŸºç¡€è¿æ¥...');
                
                const response = await fetch(`${API_BASE}/ping`);
                const data = await response.json();
                
                addResult('âœ… åŸºç¡€è¿æ¥æµ‹è¯•æˆåŠŸ', 
                    `çŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                addResult('âŒ åŸºç¡€è¿æ¥æµ‹è¯•å¤±è´¥', 
                    `é”™è¯¯: ${error.message}\nè¯¦æƒ…: ${error.stack}`, false);
            }
        }
        
        async function testProducts() {
            try {
                addResult('å¼€å§‹æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•å•†å“API...');
                
                const response = await fetch(`${API_BASE}/api/v1/products`);
                const data = await response.json();
                
                addResult('âœ… å•†å“APIæµ‹è¯•æˆåŠŸ', 
                    `çŠ¶æ€ç : ${response.status}\nå•†å“æ•°é‡: ${data.data?.products?.length || 0}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                addResult('âŒ å•†å“APIæµ‹è¯•å¤±è´¥', 
                    `é”™è¯¯: ${error.message}\nè¯¦æƒ…: ${error.stack}`, false);
            }
        }
        
        async function testCategories() {
            try {
                addResult('å¼€å§‹æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•åˆ†ç±»API...');
                
                const response = await fetch(`${API_BASE}/api/v1/categories`);
                const data = await response.json();
                
                addResult('âœ… åˆ†ç±»APIæµ‹è¯•æˆåŠŸ', 
                    `çŠ¶æ€ç : ${response.status}\nåˆ†ç±»æ•°é‡: ${data.data?.length || 0}\nå“åº”: ${JSON.stringify(data, null, 2)}`);
            } catch (error) {
                addResult('âŒ åˆ†ç±»APIæµ‹è¯•å¤±è´¥', 
                    `é”™è¯¯: ${error.message}\nè¯¦æƒ…: ${error.stack}`, false);
            }
        }
        
        async function testLogin() {
            try {
                addResult('å¼€å§‹æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•ç™»å½•API...');

                const response = await fetch(`${API_BASE}/api/v1/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: 'admin',
                        password: 'admin123'
                    })
                });

                const data = await response.json();

                if (data.code === 200) {
                    // ä¿å­˜tokenç”¨äºåç»­æµ‹è¯•
                    window.testToken = data.data.token;
                    addResult('âœ… ç™»å½•APIæµ‹è¯•æˆåŠŸ',
                        `çŠ¶æ€ç : ${response.status}\nç”¨æˆ·: ${data.data?.user?.username}\nToken: ${data.data?.token?.substring(0, 50)}...`);
                } else {
                    addResult('âš ï¸ ç™»å½•APIå“åº”å¼‚å¸¸',
                        `çŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, false);
                }
            } catch (error) {
                addResult('âŒ ç™»å½•APIæµ‹è¯•å¤±è´¥',
                    `é”™è¯¯: ${error.message}\nè¯¦æƒ…: ${error.stack}`, false);
            }
        }

        async function testCart() {
            try {
                addResult('å¼€å§‹æµ‹è¯•', 'æ­£åœ¨æµ‹è¯•è´­ç‰©è½¦API...');

                // å¦‚æœæ²¡æœ‰tokenï¼Œå…ˆç™»å½•
                if (!window.testToken) {
                    await testLogin();
                    await new Promise(resolve => setTimeout(resolve, 500)); // ç­‰å¾…ç™»å½•å®Œæˆ
                }

                if (!window.testToken) {
                    addResult('âŒ è´­ç‰©è½¦APIæµ‹è¯•å¤±è´¥', 'æ— æ³•è·å–ç™»å½•Token', false);
                    return;
                }

                // æµ‹è¯•æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦
                const response = await fetch(`${API_BASE}/api/v1/cart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${window.testToken}`
                    },
                    body: JSON.stringify({
                        product_id: 1,
                        quantity: 1
                    })
                });

                const data = await response.json();

                if (data.code === 200) {
                    addResult('âœ… è´­ç‰©è½¦APIæµ‹è¯•æˆåŠŸ',
                        `çŠ¶æ€ç : ${response.status}\nå“åº”: ${data.message}`);
                } else {
                    addResult('âš ï¸ è´­ç‰©è½¦APIå“åº”å¼‚å¸¸',
                        `çŠ¶æ€ç : ${response.status}\nå“åº”: ${JSON.stringify(data, null, 2)}`, false);
                }
            } catch (error) {
                addResult('âŒ è´­ç‰©è½¦APIæµ‹è¯•å¤±è´¥',
                    `é”™è¯¯: ${error.message}\nè¯¦æƒ…: ${error.stack}`, false);
            }
        }

        async function runAllTests() {
            addResult('ğŸš€ å¼€å§‹æ‰¹é‡æµ‹è¯•', 'æ­£åœ¨è¿è¡Œæ‰€æœ‰APIæµ‹è¯•...');
            clearResults();

            const tests = [
                { name: 'åŸºç¡€è¿æ¥', func: testPing },
                { name: 'å•†å“API', func: testProducts },
                { name: 'åˆ†ç±»API', func: testCategories },
                { name: 'ç™»å½•API', func: testLogin },
                { name: 'è´­ç‰©è½¦API', func: testCart }
            ];

            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                addResult(`ğŸ”„ è¿è¡Œæµ‹è¯• ${i + 1}/${tests.length}`, `æ­£åœ¨æµ‹è¯•: ${test.name}`);

                try {
                    await test.func();
                    await new Promise(resolve => setTimeout(resolve, 500)); // æµ‹è¯•é—´éš”
                } catch (error) {
                    addResult(`âŒ æµ‹è¯•å¤±è´¥: ${test.name}`, `é”™è¯¯: ${error.message}`, false);
                }
            }

            addResult('ğŸ‰ æ‰¹é‡æµ‹è¯•å®Œæˆ', `æ‰€æœ‰æµ‹è¯•å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹ç»“æœ`);
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        document.addEventListener('DOMContentLoaded', function() {
            addResult('é¡µé¢åŠ è½½å®Œæˆ', 'å¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            setTimeout(testPing, 1000);
        });
    </script>
</body>
</html>
