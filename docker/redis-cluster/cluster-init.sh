#!/bin/bash

# Redisé›†ç¾¤åˆå§‹åŒ–è„šæœ¬
echo "ğŸš€ å¼€å§‹åˆå§‹åŒ–Redisé›†ç¾¤..."

# ç­‰å¾…æ‰€æœ‰RedisèŠ‚ç‚¹å¯åŠ¨
echo "â³ ç­‰å¾…RedisèŠ‚ç‚¹å¯åŠ¨..."
sleep 30

# æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å¯ç”¨
check_node() {
    local ip=$1
    local port=$2
    echo "æ£€æŸ¥èŠ‚ç‚¹ $ip:$port..."
    
    for i in {1..30}; do
        if redis-cli -h $ip -p $port ping > /dev/null 2>&1; then
            echo "âœ… èŠ‚ç‚¹ $ip:$port å·²å°±ç»ª"
            return 0
        fi
        echo "â³ ç­‰å¾…èŠ‚ç‚¹ $ip:$port å¯åŠ¨... ($i/30)"
        sleep 2
    done
    
    echo "âŒ èŠ‚ç‚¹ $ip:$port å¯åŠ¨å¤±è´¥"
    return 1
}

# æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹
echo "ğŸ” æ£€æŸ¥æ‰€æœ‰RedisèŠ‚ç‚¹çŠ¶æ€..."

if ! check_node "172.20.0.11" "6379"; then
    echo "âŒ é›†ç¾¤åˆå§‹åŒ–å¤±è´¥ï¼šèŠ‚ç‚¹ 172.20.0.11:6379 ä¸å¯ç”¨"
    exit 1
fi

if ! check_node "172.20.0.12" "6379"; then
    echo "âŒ é›†ç¾¤åˆå§‹åŒ–å¤±è´¥ï¼šèŠ‚ç‚¹ 172.20.0.12:6379 ä¸å¯ç”¨"
    exit 1
fi

if ! check_node "172.20.0.13" "6379"; then
    echo "âŒ é›†ç¾¤åˆå§‹åŒ–å¤±è´¥ï¼šèŠ‚ç‚¹ 172.20.0.13:6379 ä¸å¯ç”¨"
    exit 1
fi

if ! check_node "172.20.0.14" "6379"; then
    echo "âŒ é›†ç¾¤åˆå§‹åŒ–å¤±è´¥ï¼šèŠ‚ç‚¹ 172.20.0.14:6379 ä¸å¯ç”¨"
    exit 1
fi

if ! check_node "172.20.0.15" "6379"; then
    echo "âŒ é›†ç¾¤åˆå§‹åŒ–å¤±è´¥ï¼šèŠ‚ç‚¹ 172.20.0.15:6379 ä¸å¯ç”¨"
    exit 1
fi

if ! check_node "172.20.0.16" "6379"; then
    echo "âŒ é›†ç¾¤åˆå§‹åŒ–å¤±è´¥ï¼šèŠ‚ç‚¹ 172.20.0.16:6379 ä¸å¯ç”¨"
    exit 1
fi

echo "âœ… æ‰€æœ‰èŠ‚ç‚¹å·²å°±ç»ªï¼Œå¼€å§‹åˆ›å»ºé›†ç¾¤..."

# åˆ›å»ºRedisé›†ç¾¤
# 3ä¸ªä¸»èŠ‚ç‚¹ï¼Œ3ä¸ªä»èŠ‚ç‚¹ï¼Œæ¯ä¸ªä¸»èŠ‚ç‚¹æœ‰1ä¸ªä»èŠ‚ç‚¹
redis-cli --cluster create \
    172.20.0.11:6379 \
    172.20.0.12:6379 \
    172.20.0.13:6379 \
    172.20.0.14:6379 \
    172.20.0.15:6379 \
    172.20.0.16:6379 \
    --cluster-replicas 1 \
    --cluster-yes

if [ $? -eq 0 ]; then
    echo "ğŸ‰ Redisé›†ç¾¤åˆ›å»ºæˆåŠŸï¼"
    
    # æ˜¾ç¤ºé›†ç¾¤ä¿¡æ¯
    echo ""
    echo "ğŸ“Š é›†ç¾¤ä¿¡æ¯ï¼š"
    redis-cli -h 172.20.0.11 -p 6379 cluster info
    
    echo ""
    echo "ğŸ”— é›†ç¾¤èŠ‚ç‚¹ï¼š"
    redis-cli -h 172.20.0.11 -p 6379 cluster nodes
    
    echo ""
    echo "âœ… Redisé›†ç¾¤éƒ¨ç½²å®Œæˆï¼"
    echo "ğŸŒ é›†ç¾¤è®¿é—®åœ°å€ï¼š"
    echo "   - èŠ‚ç‚¹1: 172.20.0.11:6379"
    echo "   - èŠ‚ç‚¹2: 172.20.0.12:6379"
    echo "   - èŠ‚ç‚¹3: 172.20.0.13:6379"
    echo "   - èŠ‚ç‚¹4: 172.20.0.14:6379"
    echo "   - èŠ‚ç‚¹5: 172.20.0.15:6379"
    echo "   - èŠ‚ç‚¹6: 172.20.0.16:6379"
    echo ""
    echo "ğŸ¯ Redis Insightç®¡ç†ç•Œé¢: http://localhost:8001"
    
else
    echo "âŒ Redisé›†ç¾¤åˆ›å»ºå¤±è´¥"
    exit 1
fi

# ä¿æŒå®¹å™¨è¿è¡Œ
echo "ğŸ”„ é›†ç¾¤åˆå§‹åŒ–å®Œæˆï¼Œä¿æŒç›‘æ§çŠ¶æ€..."
while true; do
    sleep 60
    # æ£€æŸ¥é›†ç¾¤å¥åº·çŠ¶æ€
    if ! redis-cli -h 172.20.0.11 -p 6379 cluster info | grep -q "cluster_state:ok"; then
        echo "âš ï¸  æ£€æµ‹åˆ°é›†ç¾¤çŠ¶æ€å¼‚å¸¸"
        redis-cli -h 172.20.0.11 -p 6379 cluster info
    fi
done
