# AlertManager 配置文件
global:
  # SMTP 配置
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'ryan-mall-alerts@example.com'
  smtp_auth_username: 'your-email@gmail.com'
  smtp_auth_password: 'your-app-password'
  
  # 默认接收者
  smtp_require_tls: true

# 模板配置
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# 路由配置
route:
  # 默认接收者
  receiver: 'default-receiver'
  
  # 分组配置
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  
  # 路由规则
  routes:
    # 关键告警 - 立即通知
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5m
      repeat_interval: 15m
      
    # 警告告警 - 延迟通知
    - match:
        severity: warning
      receiver: 'warning-alerts'
      group_wait: 30s
      group_interval: 10m
      repeat_interval: 1h
      
    # Redis相关告警
    - match:
        service: redis
      receiver: 'redis-alerts'
      group_wait: 10s
      
    # MySQL相关告警
    - match:
        service: mysql
      receiver: 'mysql-alerts'
      group_wait: 10s
      
    # 应用程序告警
    - match:
        service: ryan-mall
      receiver: 'app-alerts'
      group_wait: 5s

# 抑制规则
inhibit_rules:
  # 如果应用宕机，抑制其他相关告警
  - source_match:
      alertname: 'RyanMallAppDown'
    target_match:
      service: 'ryan-mall'
    equal: ['instance']
    
  # 如果Redis集群宕机，抑制单个节点告警
  - source_match:
      alertname: 'RedisClusterStateError'
    target_match:
      alertname: 'RedisNodeDown'
    equal: ['cluster']

# 接收者配置
receivers:
  # 默认接收者
  - name: 'default-receiver'
    email_configs:
      - to: 'admin@example.com'
        subject: '[Ryan Mall] 监控告警'
        body: |
          告警详情:
          - 告警名称: {{ .GroupLabels.alertname }}
          - 严重程度: {{ .GroupLabels.severity }}
          - 服务名称: {{ .GroupLabels.service }}
          - 告警时间: {{ .CommonAnnotations.summary }}
          - 详细描述: {{ .CommonAnnotations.description }}
          
          查看详情: http://localhost:3000

  # 关键告警接收者
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@example.com,ops@example.com'
        subject: '[CRITICAL] Ryan Mall 关键告警'
        body: |
          🚨 关键告警 🚨
          
          告警名称: {{ .GroupLabels.alertname }}
          服务名称: {{ .GroupLabels.service }}
          告警时间: {{ .FireTime }}
          
          {{ range .Alerts }}
          - 实例: {{ .Labels.instance }}
          - 描述: {{ .Annotations.description }}
          {{ end }}
          
          请立即处理！
          监控面板: http://localhost:3000
    
    # Webhook 通知（可选）
    webhook_configs:
      - url: 'http://localhost:8080/api/v1/alerts/webhook'
        send_resolved: true

  # 警告告警接收者
  - name: 'warning-alerts'
    email_configs:
      - to: 'ops@example.com'
        subject: '[WARNING] Ryan Mall 警告告警'
        body: |
          ⚠️ 警告告警 ⚠️
          
          告警名称: {{ .GroupLabels.alertname }}
          服务名称: {{ .GroupLabels.service }}
          
          {{ range .Alerts }}
          - 实例: {{ .Labels.instance }}
          - 描述: {{ .Annotations.description }}
          {{ end }}
          
          监控面板: http://localhost:3000

  # Redis告警接收者
  - name: 'redis-alerts'
    email_configs:
      - to: 'dba@example.com'
        subject: '[Redis] 缓存系统告警'
        body: |
          🔴 Redis告警 🔴
          
          告警名称: {{ .GroupLabels.alertname }}
          集群名称: {{ .GroupLabels.cluster }}
          
          {{ range .Alerts }}
          - 节点: {{ .Labels.instance }}
          - 描述: {{ .Annotations.description }}
          {{ end }}
          
          Redis监控: http://localhost:3000/d/redis

  # MySQL告警接收者
  - name: 'mysql-alerts'
    email_configs:
      - to: 'dba@example.com'
        subject: '[MySQL] 数据库告警'
        body: |
          🔵 MySQL告警 🔵
          
          告警名称: {{ .GroupLabels.alertname }}
          数据库: {{ .GroupLabels.instance }}
          
          {{ range .Alerts }}
          - 描述: {{ .Annotations.description }}
          {{ end }}
          
          MySQL监控: http://localhost:3000/d/mysql

  # 应用程序告警接收者
  - name: 'app-alerts'
    email_configs:
      - to: 'dev@example.com'
        subject: '[App] Ryan Mall应用告警'
        body: |
          🟡 应用告警 🟡
          
          告警名称: {{ .GroupLabels.alertname }}
          应用实例: {{ .GroupLabels.instance }}
          
          {{ range .Alerts }}
          - 描述: {{ .Annotations.description }}
          {{ end }}
          
          应用监控: http://localhost:3000/d/ryan-mall

# 静默配置示例
# silences:
#   - matchers:
#       - name: alertname
#         value: HighCPUUsage
#     startsAt: "2023-01-01T00:00:00Z"
#     endsAt: "2023-01-01T01:00:00Z"
#     createdBy: admin
#     comment: "维护期间静默CPU告警"
